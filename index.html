<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced First Aid Kit Locator</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        #kit-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .kit-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #ccc;
        }
        .kit-item:hover {
            background: #f0f0f0;
        }
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        #slideout-panel {
            position: absolute;
            top: 0;
            right: -300px;
            width: 300px;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease;
        }
        #slideout-panel.open {
            right: 0;
        }
        .close-slideout {
            cursor: pointer;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <h2>First Aid Kits</h2>
        <select id="sort-select">
            <option value="alphabetical">Sort Alphabetically</option>
            <!-- Add more sorting options if needed -->
        </select>
        <div id="kit-list"></div>
        <button id="nearby">Find Nearby Kits</button>
    </div>
    <div id="loading-indicator">Loading...</div>
    <div id="slideout-panel">
        <div class="close-slideout">âœ–</div>
        <div id="slideout-content"></div>
    </div>

    <script>
    (function() {
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ';
        const GEOJSON_URL = 'https://raw.githubusercontent.com/ehs-uoft/FA/main/geojson.geojson';
        const TORONTO_COORDINATES = [-79.3832, 43.6532];
        const DEFAULT_ZOOM = 13;

        let map, kitFeatures = [];
        let is3DMode = false;

        function initializeMap() {
            mapboxgl.accessToken = MAPBOX_TOKEN;

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: TORONTO_COORDINATES,
                zoom: DEFAULT_ZOOM
            });

            map.on('load', onMapLoad);
        }

        function onMapLoad() {
            console.log('Map loaded');
            fetchGeoJSONData();
            addEventListeners();
        }

        function fetchGeoJSONData() {
            console.log('Fetching GeoJSON data');
            showLoading(true);
            fetch(GEOJSON_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('GeoJSON data loaded', data);
                    kitFeatures = data.features;
                    addMapLayers(data);
                    updateInfoPanel();
                    fitMapToData();
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error fetching GeoJSON:', error);
                    showLoading(false);
                    alert('Failed to load data. Please try again later.');
                });
        }

        function addMapLayers(data) {
            console.log('Adding map layers');
            if (!map.getSource('kits')) {
                map.addSource('kits', {
                    type: 'geojson',
                    data: data
                });

                map.addLayer({
                    id: 'kit-locations',
                    type: 'circle',
                    source: 'kits',
                    paint: {
                        'circle-radius': 8,
                        'circle-color': '#27ae60',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                map.on('click', 'kit-locations', onKitClick);
                map.on('mouseenter', 'kit-locations', () => { map.getCanvas().style.cursor = 'pointer'; });
                map.on('mouseleave', 'kit-locations', () => { map.getCanvas().style.cursor = ''; });
            } else {
                map.getSource('kits').setData(data);
            }
        }

        function addEventListeners() {
            document.getElementById('collapse-button').addEventListener('click', toggleInfoPanel);
            document.getElementById('sort-select').addEventListener('change', (e) => updateInfoPanel(e.target.value));
            document.getElementById('search-box').addEventListener('input', debounce(handleSearch, 300));
            document.querySelector('.close-slideout').addEventListener('click', closeSlideout);
            document.getElementById('nearby').addEventListener('click', showNearbyLocation);
        }

        function updateInfoPanel(sortBy = 'alphabetical') {
            console.log('Updating info panel');
            const kitList = document.getElementById('kit-list');
            kitList.innerHTML = '';

            let sortedBuildings = [...kitFeatures];
            
            if (sortBy === 'alphabetical') {
                sortedBuildings.sort((a, b) => a.properties.building.localeCompare(b.properties.building));
            }

            sortedBuildings.forEach(feature => {
                const div = document.createElement('div');
                div.className = 'kit-item';
                div.innerHTML = `
                    <strong>${feature.properties.building}</strong><br>
                    Kits: ${feature.properties.kitCount || 1}
                `;
                div.addEventListener('click', () => {
                    flyToBuilding(feature.geometry.coordinates);
                    showSlideout(feature.properties.buildingId || feature.properties.building);
                });
                kitList.appendChild(div);
            });
        }

        function onKitClick(e) {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const props = e.features[0].properties;

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            showSlideout(props.buildingId || props.building);
        }

        function showSlideout(buildingId) {
            const feature = kitFeatures.find(f => f.properties.buildingId === buildingId || f.properties.building === buildingId);
            if (feature) {
                const props = feature.properties;
                const content = document.getElementById('slideout-content');
                content.innerHTML = `
                    <h2>${props.building}</h2>
                    <p><strong>Address:</strong> ${props.address}</p>
                    <p><strong>Total Kits:</strong> ${props.kitCount || 1}</p>
                    ${props.url ? `<p><strong>URL:</strong> <a href="${props.url}" target="_blank">${props.url}</a></p>` : ''}
                    ${props.kits ? `
                        <h3>Kit Locations:</h3>
                        <ul>
                            ${props.kits.map(kit => `
                                <li>
                                    Room: ${kit.room}, Floor: ${kit.floor}
                                    ${kit.otherDetails ? `<br>Details: ${kit.otherDetails}` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                    <button id="report-issue-building">Report Issue</button>
                `;
                document.getElementById('slideout-panel').classList.add('open');

                document.getElementById('report-issue-building').addEventListener('click', () => reportIssue(buildingId));
            }
        }

        function closeSlideout() {
            document.getElementById('slideout-panel').classList.remove('open');
        }

        function reportIssue(buildingId) {
            alert(`Reporting issue for building ID: ${buildingId}`);
            // Implement reporting functionality
        }

        function showNearbyLocation() {
            // Get current location (this is a placeholder, implement actual location fetching)
            const currentLocation = [-79.3832, 43.6532]; // Toronto coordinates
            const nearestKit = findNearestKit(currentLocation);

            if (nearestKit) {
                flyToBuilding(nearestKit.geometry.coordinates);
                alert(`Nearest Kit: ${nearestKit.properties.building} at ${nearestKit.properties.address}`);
            } else {
                alert('No nearby kits found.');
            }
        }

        function findNearestKit(location) {
            const nearest = turf.nearestPoint(
                turf.point(location),
                turf.featureCollection(kitFeatures)
            );
            return nearest;
        }

        function flyToBuilding(coordinates) {
            map.flyTo({
                center: coordinates,
                zoom: 16,
                essential: true // This animation is considered essential with respect to prefers-reduced-motion
            });
        }

        function fitMapToData() {
            const bounds = turf.bbox(turf.featureCollection(kitFeatures));
            map.fitBounds(bounds, { padding: 20 });
        }

        function showLoading(isLoading) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
        }

        // Debounce function to limit search calls
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(null, args);
                }, delay);
            };
        }

        initializeMap();
    })();
    </script>
</body>
</html>
