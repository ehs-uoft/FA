<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>UTSG First Aid Kit Locator</title>
    <meta name="description" content="Locate first aid kits across the University of Toronto St. George campus">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 10c-17.6 0-32 14.4-32 32 0 24 32 48 32 48s32-24 32-48c0-17.6-14.4-32-32-32zm0 44c-6.6 0-12-5.4-12-12s5.4-12 12-12 12 5.4 12 12-5.4 12-12 12z%22 fill=%22%23e74c3c%22/></svg>">
    
    <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" as="style">
    <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" as="script">
    <link rel="preconnect" href="https://api.mapbox.com">
    <link rel="preconnect" href="https://events.mapbox.com">
    
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --background-color: #f8f9fa;
        --text-color: #2c3e50;
        --panel-background: rgba(255, 255, 255, 0.98);
        --hover-color: #f1f5f9;
        --border-color: #e2e8f0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --base-font-size: 16px;
        --transition-speed: 0.3s;
    }

    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: var(--base-font-size);
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
    }

    body { 
        margin: 0; 
        padding: 0; 
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        color: var(--text-color);
        background-color: var(--background-color);
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
    }

    #map { 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        width: 100%; 
        height: 100%;
        z-index: 1;
    }

    #loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        will-change: transform;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 15px;
        font-size: 0.9rem;
        color: var(--primary-color);
    }

    #error-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-color);
        z-index: 2001;
        display: none;
        text-align: center;
        max-width: 90%;
        font-size: 0.9rem;
        pointer-events: none;
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -20px); }
        to { opacity: 1; transform: translate(-50%, 0); }
    }

    #info-panel {
        position: absolute; 
        top: 0; 
        right: 0; 
        width: 380px;
        height: 100vh;
        background: var(--panel-background);
        box-shadow: -2px 0 10px var(--shadow-color); 
        transform: translateX(0);
        transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        overscroll-behavior: contain;
        contain: layout size;
        will-change: transform;
    }

    #info-panel.collapsed { 
        transform: translateX(380px); 
    }

    #collapse-button {
        position: absolute; 
        left: -45px; 
        top: 20px; 
        background: var(--primary-color);
        color: white;
        border: none; 
        border-radius: 5px 0 0 5px; 
        padding: 12px;
        cursor: pointer;
        transition: background-color var(--transition-speed) ease;
        box-shadow: -2px 0 5px var(--shadow-color);
        font-size: 1.2em;
        z-index: 1002;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    #collapse-button:hover {
        background-color: var(--secondary-color);
    }

    .panel-header {
        padding: 20px;
        background: var(--primary-color);
        color: white;
        flex-shrink: 0;
    }

    .panel-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #search-box {
        margin: 15px 20px;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color var(--transition-speed) ease,
                    box-shadow var(--transition-speed) ease;
        width: calc(100% - 40px);
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
    }

    #search-box:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    #kit-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 20px;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        overscroll-behavior: contain;
        contain: content;
    }

    .kit-item { 
        background: white; 
        margin-bottom: 15px; 
        padding: 15px;
        border-radius: 8px;
        cursor: pointer; 
        transition: transform var(--transition-speed) ease,
                    box-shadow var(--transition-speed) ease,
                    border-color var(--transition-speed) ease;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px var(--shadow-color);
        position: relative;
        will-change: transform;
        contain: layout style;
    }

    .kit-item:hover { 
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
        border-color: var(--secondary-color);
    }

    .kit-item h3 {
        font-size: 1.3em;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: var(--primary-color);
        line-height: 1.3;
    }

    .kit-item p {
        font-size: 1.1em;
        margin: 0;
        color: #666;
        line-height: 1.4;
    }
        #font-controls {
        position: absolute;
        bottom: 20px;
        right: 400px;
        background: var(--panel-background);
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-color);
        z-index: 1000;
        display: flex;
        gap: 10px;
        align-items: center;
        contain: content;
    }

    .font-control-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color var(--transition-speed) ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        will-change: background-color;
    }

    .font-control-btn:hover {
        background: var(--secondary-color);
    }

    .custom-ctrl-button {
        width: 40px !important;
        height: 40px !important;
        padding: 5px !important;
        background: white !important;
        border: none !important;
        cursor: pointer !important;
    }

    .custom-ctrl-button:hover {
        background: #f0f0f0 !important;
    }

    .mapboxgl-popup {
        max-width: 300px !important;
        z-index: 1003;
    }

    .mapboxgl-popup-content {
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-color);
        font-size: 1rem;
    }

    .mapboxgl-ctrl-group {
        background-color: var(--panel-background) !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px var(--shadow-color) !important;
        margin-top: 15px !important;
        overflow: hidden;
    }

    .mapboxgl-ctrl-group button {
        width: 45px !important;
        height: 45px !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        transition: background-color var(--transition-speed) ease;
    }

    .map-legend {
        position: absolute;
        bottom: 30px;
        right: 400px;
        background: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }

    .legend-marker {
        width: 20px;
        height: 20px;
        margin-right: 8px;
    }

    .legend-marker.first-aid {
        background: #006400;
        border-radius: 50%;
        position: relative;
    }

    .legend-marker.first-aid:after {
        content: '+';
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .legend-marker.cluster {
        background: #51bbd6;
        border-radius: 50%;
    }

    #last-updated {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.9em;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    @media (max-width: 768px) {
        #last-updated {
            bottom: calc(50vh + 20px);
        }
    }

    @media (max-width: 1024px) {
        #info-panel {
            width: 320px;
        }

        #info-panel.collapsed {
            transform: translateX(320px);
        }

        .kit-item h3 {
            font-size: 1.2em;
        }

        .kit-item p {
            font-size: 1em;
        }

        #font-controls {
            right: 340px;
        }
    }

    @media (max-width: 768px) {
        #info-panel {
            width: 100%;
            height: 50vh;
            top: auto;
            bottom: 0;
            transform: translateY(0);
        }

        #info-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }

        #collapse-button {
            left: 10px;
            top: -45px;
            transform: rotate(180deg);
        }

        .panel-header {
            padding: 15px;
        }

        #font-controls {
            right: 10px;
            bottom: calc(50vh + 20px);
        }

        .mapboxgl-ctrl-group button {
            width: 40px !important;
            height: 40px !important;
        }
    }

    @media (hover: none) {
        .kit-item:active {
            transform: translateY(-2px);
            background-color: var(--hover-color);
        }

        .font-control-btn {
            padding: 12px 15px;
        }
    }

    @media (prefers-color-scheme: dark) {
        .mapboxgl-popup-content {
            background-color: #333;
            color: #fff;
        }

        .kit-item {
            background: #2c2c2c;
            border-color: #444;
        }

        .kit-item h3 {
            color: #fff;
        }

        .kit-item p {
            color: #ccc;
        }
    }

    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
    }
</style>
</head>
<body>
    <div id="map"></div>
    <div id="error-message"></div>
    <div id="loading-indicator">
        <div class="spinner"></div>
        <div class="loading-text">Loading map data...</div>
    </div>
    <div id="font-controls">
        <button class="font-control-btn" id="decrease-font" title="Decrease font size">A-</button>
        <button class="font-control-btn" id="increase-font" title="Increase font size">A+</button>
    </div>
    <div id="info-panel">
        <button id="collapse-button" aria-label="Toggle info panel">≡</button>
        <div class="panel-header">
            <h2>First Aid Kit Locations</h2>
        </div>
        <input type="text" 
               id="search-box" 
               placeholder="Search for a building..." 
               aria-label="Search for a building"
               autocomplete="off"
               spellcheck="false">
        <div id="kit-list"></div>
    </div>
    <div id="legend" class="map-legend">
        <h4>Legend</h4>
        <div class="legend-item">
            <div class="legend-marker first-aid"></div>
            <span>First Aid Kit Location</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker cluster"></div>
            <span>Multiple Locations</span>
        </div>
    </div>
    <div id="last-updated">Last Updated: Loading...</div>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
// Performance monitoring initialization
const perf = {
    marks: new Map(),
    start: (name) => {
        perf.marks.set(name, performance.now());
    },
    end: (name) => {
        const start = perf.marks.get(name);
        if (start) {
            const duration = performance.now() - start;
            console.log(`${name}: ${duration.toFixed(2)}ms`);
            perf.marks.delete(name);
        }
    }
};

(function() {
    'use strict';

    // Constants
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ';
    const GEOJSON_URL = '/FA/geojson.geojson';
    const UNIVERSITY_OF_TORONTO_COORDINATES = [-79.3957, 43.6629];
    const MAP_BOUNDS = [
        [-79.4057, 43.6529], // Southwest coordinates
        [-79.3857, 43.6729]  // Northeast coordinates
    ];
    const LOAD_TIMEOUT = 15000; // 15 seconds
    
    // State management
    const state = {
        map: null,
        kitFeatures: [],
        mapLoaded: false,
        dataLoaded: false,
        loadingTimeout: null,
        currentFontSize: 1,
        searchDebounceTimeout: null,
        errorTimeout: null
    };

    // DOM Elements Cache
    const elements = {
        map: null,
        loading: null,
        error: null,
        infoPanel: null,
        searchBox: null,
        kitList: null
    };

    async function getLastModifiedDate() {
        try {
            const response = await fetch('https://api.github.com/repos/ehs-uoft/FA/commits?path=geojson.geojson&page=1&per_page=1');
            const [latestCommit] = await response.json();
            const date = new Date(latestCommit.commit.committer.date);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } catch (error) {
            console.error('Error fetching last modified date:', error);
            return 'Date unavailable';
        }
    }

    async function updateLastModifiedDate() {
        const dateString = await getLastModifiedDate();
        document.getElementById('last-updated').textContent = `Last Updated: ${dateString}`;
    }

    // Initialize DOM elements cache
    function cacheElements() {
        elements.map = document.getElementById('map');
        elements.loading = document.getElementById('loading-indicator');
        elements.error = document.getElementById('error-message');
        elements.infoPanel = document.getElementById('info-panel');
        elements.searchBox = document.getElementById('search-box');
        elements.kitList = document.getElementById('kit-list');
    }
    // Error handling
    function showError(message, duration = 5000) {
        if (state.errorTimeout) {
            clearTimeout(state.errorTimeout);
        }
        
        elements.error.textContent = message;
        elements.error.style.display = 'block';
        
        state.errorTimeout = setTimeout(() => {
            elements.error.style.display = 'none';
        }, duration);
    }

    // Loading management
    function showLoading(show) {
        elements.loading.style.display = show ? 'flex' : 'none';
    }

    function checkLoadingComplete() {
        if (state.mapLoaded && state.dataLoaded) {
            if (state.loadingTimeout) {
                clearTimeout(state.loadingTimeout);
            }
            showLoading(false);
            perf.end('totalLoad');
        }
    }

    // Map initialization
    async function initializeMap() {
        perf.start('mapInit');
        
        try {
            state.loadingTimeout = setTimeout(() => {
                showLoading(false);
                showError('Loading is taking longer than expected. Please refresh the page.');
            }, LOAD_TIMEOUT);

            mapboxgl.accessToken = MAPBOX_TOKEN;

            const mapOptions = {
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: UNIVERSITY_OF_TORONTO_COORDINATES,
                zoom: 15,
                minZoom: 14,
                maxBounds: MAP_BOUNDS,
                preserveDrawingBuffer: true,
                trackResize: true,
                renderWorldCopies: false,
                optimizeForTerrain: true,
                maxPitch: 60,
                antialias: true
            };

            if ('ontouchstart' in window) {
                Object.assign(mapOptions, {
                    dragRotate: false,
                    touchPitch: false
                });
            }

            state.map = new mapboxgl.Map(mapOptions);

            state.map.once('load', () => {
                state.mapLoaded = true;
                perf.end('mapInit');
                onMapLoad();
                checkLoadingComplete();
            });

            state.map.on('error', (e) => {
                console.error('Map error:', e);
                showError('Error loading map. Please check your internet connection.');
                showLoading(false);
            });

        } catch (error) {
            console.error('Map initialization error:', error);
            showError('Failed to initialize map. Please refresh the page.');
            showLoading(false);
        }
    }

    // GeoJSON data fetching
    async function fetchGeoJSONData() {
        perf.start('dataFetch');
        
        try {
            const response = await fetch(GEOJSON_URL, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (!data || !data.features || !Array.isArray(data.features)) {
                throw new Error('Invalid data format');
            }

            state.kitFeatures = data.features;
            state.dataLoaded = true;
            updateLastModifiedDate();
            
            perf.end('dataFetch');
            
            if (state.mapLoaded) {
                addMapLayers(data);
                updateVisibleBuildings();
            }
            
            checkLoadingComplete();
            return data;

        } catch (error) {
            console.error('Error fetching GeoJSON:', error);
            showError('Failed to load location data. Please try again later.');
            showLoading(false);
        }
    }
// Add map layers
    function addMapLayers(data) {
        // Create a canvas element
const canvas = document.createElement('canvas');
canvas.width = 32;
canvas.height = 32;
const ctx = canvas.getContext('2d');

// Draw the first aid icon
ctx.beginPath();
ctx.arc(16, 16, 14, 0, 2 * Math.PI); // Circle
ctx.fillStyle = '#006400';
ctx.fill();

// Draw the white cross
ctx.fillStyle = 'white';
// Horizontal bar
ctx.fillRect(8, 14, 16, 4);
// Vertical bar
ctx.fillRect(14, 8, 4, 16);

// Create the image
state.map.addImage('first-aid', { 
    width: 32, 
    height: 32, 
    data: new Uint8Array(ctx.getImageData(0, 0, 32, 32).data)
});
                
                // Add source
                state.map.addSource('kits', {
                    type: 'geojson',
                    data: data,
                    cluster: true,
                    clusterMaxZoom: 14,
                    clusterRadius: 50
                });

                // Add cluster layer
                state.map.addLayer({
                    id: 'clusters',
                    type: 'circle',
                    source: 'kits',
                    filter: ['has', 'point_count'],
                    paint: {
                        'circle-color': [
                            'step',
                            ['get', 'point_count'],
                            '#51bbd6',
                            100,
                            '#f1f075',
                            750,
                            '#f28cb1'
                        ],
                        'circle-radius': [
                            'step',
                            ['get', 'point_count'],
                            20,
                            100,
                            30,
                            750,
                            40
                        ]
                    }
                });

                // Add cluster count layer
                state.map.addLayer({
                    id: 'cluster-count',
                    type: 'symbol',
                    source: 'kits',
                    filter: ['has', 'point_count'],
                    layout: {
                        'text-field': '{point_count_abbreviated}',
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    }
                });

                // Add unclustered point layer
                state.map.addLayer({
                    id: 'unclustered-point',
                    type: 'symbol',
                    source: 'kits',
                    filter: ['!', ['has', 'point_count']],
                    layout: {
                        'icon-image': 'first-aid',
                        'icon-size': 0.8,
                        'icon-allow-overlap': true
                    }
                });

                // Add event listeners
                state.map.on('click', 'clusters', (e) => {
                    const features = state.map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                    const clusterId = features[0].properties.cluster_id;
                    state.map.getSource('kits').getClusterExpansionZoom(
                        clusterId,
                        (err, zoom) => {
                            if (err) return;
                            state.map.easeTo({
                                center: features[0].geometry.coordinates,
                                zoom: zoom
                            });
                        }
                    );
                });

                state.map.on('click', 'unclustered-point', (e) => {
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const properties = e.features[0].properties;

                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(`
                            <h3>${properties.building}</h3>
                            <p>${properties.address || 'No address available'}</p>
                        `)
                        .addTo(state.map);
                });

                // Change cursor on hover
                state.map.on('mouseenter', 'clusters', () => {
                    state.map.getCanvas().style.cursor = 'pointer';
                });
                state.map.on('mouseleave', 'clusters', () => {
                    state.map.getCanvas().style.cursor = '';
                });

                state.map.on('mouseenter', 'unclustered-point', () => {
                    state.map.getCanvas().style.cursor = 'pointer';
                });
                state.map.on('mouseleave', 'unclustered-point', () => {
                    state.map.getCanvas().style.cursor = '';
                });
            }
        );
    }    
    function addMapControls() {
        // Add navigation control
        const nav = new mapboxgl.NavigationControl({
            visualizePitch: true,
            showCompass: true
        });
        state.map.addControl(nav, 'top-left');

        // Add fullscreen control
        state.map.addControl(
            new mapboxgl.FullscreenControl({
                container: document.documentElement
            }),
            'top-left'
        );

        // Add scale control
        const scale = new mapboxgl.ScaleControl({
            maxWidth: 100,
            unit: 'metric'
        });
        state.map.addControl(scale, 'bottom-left');

        // Add geolocate control
        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        });
        state.map.addControl(geolocate, 'top-left');

        // Add 3D toggle button
        const toggle3DButton = document.createElement('button');
        toggle3DButton.className = 'mapboxgl-ctrl-icon custom-ctrl-button';
        toggle3DButton.innerHTML = '3D';
        toggle3DButton.onclick = () => {
            const current = state.map.getPitch();
            state.map.easeTo({
                pitch: current === 0 ? 60 : 0,
                duration: 1000
            });
        };

        // Add reset view button
        const resetViewButton = document.createElement('button');
        resetViewButton.className = 'mapboxgl-ctrl-icon custom-ctrl-button';
        resetViewButton.innerHTML = 'Reset';
        resetViewButton.onclick = () => {
            state.map.flyTo({
                center: UNIVERSITY_OF_TORONTO_COORDINATES,
                zoom: 15,
                pitch: 0,
                bearing: 0
            });
        };

        const customControls = document.createElement('div');
        customControls.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
        customControls.appendChild(toggle3DButton);
        customControls.appendChild(resetViewButton);
        state.map.addControl({ onAdd: () => customControls, onRemove: () => {} }, 'top-left');
    }

    // Building details and UI updates
    function showBuildingDetails(feature) {
        perf.start('showDetails');
        
        const coordinates = feature.geometry.coordinates;
        state.map.flyTo({
            center: coordinates,
            zoom: 17,
            speed: 1.2,
            curve: 1.42,
            essential: true,
            easing(t) {
                return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            }
        });

        requestAnimationFrame(() => {
            const listItems = elements.kitList.querySelectorAll('.kit-item');
            const buildingName = feature.properties.building;
            
            listItems.forEach(item => {
                const isMatch = item.querySelector('h3').textContent === buildingName;
                item.style.borderColor = isMatch ? 'var(--accent-color)' : 'var(--border-color)';
                
                if (isMatch) {
                    item.scrollIntoView({ 
                        behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : 'smooth',
                        block: 'nearest'
                    });
                }
            });
        });

        perf.end('showDetails');
    }

    // Visible buildings update
    function updateVisibleBuildings() {
        perf.start('updateVisible');
        
        if (!state.map || !state.map.getSource('kits')) return;

        const bounds = state.map.getBounds();
        
        const visibleFeatures = state.kitFeatures.filter(feature => {
            const [lng, lat] = feature.geometry.coordinates;
            return lng >= bounds.getWest() &&
                   lng <= bounds.getEast() &&
                   lat >= bounds.getSouth() &&
                   lat <= bounds.getNorth();
        });

        requestAnimationFrame(() => {
            updateInfoPanel(visibleFeatures);
        });

        perf.end('updateVisible');
    }
    // Info panel updates
    function updateInfoPanel(features) {
        perf.start('updatePanel');

        const fragment = document.createDocumentFragment();
        
        if (features.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.textContent = 'No buildings found in this area';
            fragment.appendChild(noResults);
        } else {
            features
                .sort((a, b) => a.properties.building.localeCompare(b.properties.building))
                .forEach(feature => {
                    const div = document.createElement('div');
                    div.className = 'kit-item';
                    div.innerHTML = `
                        <h3>${feature.properties.building}</h3>
                        <p>${feature.properties.address || 'No address available'}</p>
                    `;
                    
                    div.dataset.coordinates = JSON.stringify(feature.geometry.coordinates);
                    div.dataset.buildingData = JSON.stringify(feature);
                    
                    fragment.appendChild(div);
                });
        }

        elements.kitList.innerHTML = '';
        elements.kitList.appendChild(fragment);

        perf.end('updatePanel');
    }

    // Search functionality
    function handleSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (state.searchDebounceTimeout) {
            clearTimeout(state.searchDebounceTimeout);
        }

        state.searchDebounceTimeout = setTimeout(() => {
            perf.start('search');

            const filteredFeatures = searchTerm === '' ? 
                state.kitFeatures : 
                state.kitFeatures.filter(feature => {
                    const props = feature.properties;
                    return props.building.toLowerCase().includes(searchTerm) ||
                           (props.address && props.address.toLowerCase().includes(searchTerm));
                });

            if (state.map.getSource('kits')) {
                state.map.getSource('kits').setData({
                    type: 'FeatureCollection',
                    features: filteredFeatures
                });
            }

            requestAnimationFrame(() => {
                updateInfoPanel(filteredFeatures);
            });

            perf.end('search');
        }, 300);
    }

    // Font size controls
    function updateFontSize(increase) {
        state.currentFontSize = increase ? 
            Math.min(state.currentFontSize + 0.2, 2) : 
            Math.max(state.currentFontSize - 0.2, 0.6);

        requestAnimationFrame(() => {
            if (state.map.getLayer('kit-labels')) {
                state.map.setLayoutProperty(
                    'kit-labels',
                    'text-size',
                    [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        14, 10 * state.currentFontSize,
                        16, 12 * state.currentFontSize,
                        18, 14 * state.currentFontSize
                    ]
                );
            }

            document.documentElement.style.setProperty('--base-font-size', `${16 * state.currentFontSize}px`);

            document.querySelectorAll('.mapboxgl-popup-content').forEach(popup => {
                popup.style.fontSize = `${state.currentFontSize}rem`;
            });
        });
    }

    // Event delegation for kit list
    function handleKitListClick(e) {
        const kitItem = e.target.closest('.kit-item');
        if (!kitItem) return;

        const coordinates = JSON.parse(kitItem.dataset.coordinates);
        const buildingData = JSON.parse(kitItem.dataset.buildingData);
        
        flyToBuilding(coordinates);
        showBuildingDetails(buildingData);
    }

    // Fly to building with optimized animation
    function flyToBuilding(coordinates) {
        state.map.flyTo({
            center: coordinates,
            zoom: 17,
            speed: 1.2,
            curve: 1.42,
            essential: true,
            easing(t) {
                return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            }
        });
    }

// Event Listeners Setup
    function setupEventListeners() {
        // Map movement events
        state.map.on('moveend', debounce(updateVisibleBuildings, 100));
        state.map.on('zoomend', debounce(updateVisibleBuildings, 100));

        // Panel toggle
        document.getElementById('collapse-button').addEventListener('click', () => {
            elements.infoPanel.classList.toggle('collapsed');
        });

        // Search
        elements.searchBox.addEventListener('input', debounce(handleSearch, 300));

        // Font size controls
        document.getElementById('increase-font').addEventListener('click', () => updateFontSize(true));
        document.getElementById('decrease-font').addEventListener('click', () => updateFontSize(false));

        // Kit list delegation
        elements.kitList.addEventListener('click', handleKitListClick);

        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);

        // Window resize
        window.addEventListener('resize', debounce(() => {
            if (state.map) {
                state.map.resize();
                updateLayoutForScreenSize();
            }
        }, 250));

        // Device orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (state.map) {
                    state.map.resize();
                    updateLayoutForScreenSize();
                }
            }, 200);
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', handleVisibilityChange);
    }

    // Keyboard shortcuts handler
    function handleKeyboardShortcuts(e) {
        if (e.key === 'Escape') {
            elements.infoPanel.classList.add('collapsed');
        } else if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            elements.searchBox.focus();
        }
    }

    // Visibility change handler
    function handleVisibilityChange() {
        if (document.hidden) {
            if (state.searchDebounceTimeout) {
                clearTimeout(state.searchDebounceTimeout);
            }
        } else {
            updateVisibleBuildings();
        }
    }

    // Update layout based on screen size
    function updateLayoutForScreenSize() {
        const isMobile = window.innerWidth <= 768;
        const isLandscape = window.innerWidth > window.innerHeight;

        document.documentElement.style.fontSize = isMobile ? '14px' : '16px';

        const panel = elements.infoPanel;
        const isCollapsed = panel.classList.contains('collapsed');
        
        state.map.setPadding({
            right: (!isMobile && !isCollapsed) ? 380 : 0,
            bottom: (isMobile && !isCollapsed && !isLandscape) ? window.innerHeight / 2 : 0
        });
    }

    // Map Load Handler
    function onMapLoad() {
        addMapControls();
        updateLayoutForScreenSize();
        
        if (state.dataLoaded && state.kitFeatures.length > 0) {
            addMapLayers({
                type: 'FeatureCollection',
                features: state.kitFeatures
            });
            updateVisibleBuildings();
        }
    }

    // Debounce utility
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Resource cleanup
    function cleanup() {
        if (state.searchDebounceTimeout) {
            clearTimeout(state.searchDebounceTimeout);
        }
        if (state.loadingTimeout) {
            clearTimeout(state.loadingTimeout);
        }
        if (state.errorTimeout) {
            clearTimeout(state.errorTimeout);
        }
    }

    // Application initialization
    function initializeApplication() {
        perf.start('totalLoad');
        
        cacheElements();
        showLoading(true);

        Promise.all([
            initializeMap(),
            fetchGeoJSONData()
        ]).catch(error => {
            console.error('Initialization error:', error);
            showError('Failed to initialize application. Please refresh the page.');
        });

        setupEventListeners();
        window.addEventListener('beforeunload', cleanup);
    }

    // Start the application when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApplication);
    } else {
        initializeApplication();
    }
})();
</script>
</body>
</html>
