
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced First Aid Kit Locator</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/supercluster@7.1.2/dist/supercluster.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #info-panel {
            position: absolute; top: 10px; right: 10px; width: 300px;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        #info-panel.collapsed {
            transform: translateX(290px);
        }
        #collapse-button {
            position: absolute; left: -30px; top: 10px; background: white;
            border: none; border-radius: 5px 0 0 5px; padding: 5px;
            box-shadow: -5px 0 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        #search-box {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc;
            border-radius: 20px; box-sizing: border-box; font-size: 16px;
        }
        .kit-item { 
            background: #f0f0f0; margin-bottom: 10px; padding: 15px; 
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
        }
        .kit-item:hover { 
            background: #e0e0e0; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #legend {
            position: absolute; bottom: 30px; left: 10px; background: rgba(255,255,255,0.9);
            padding: 10px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            font-weight: bold; font-size: 14px; display: flex; align-items: center;
        }
        #legend img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .mapboxgl-popup-content {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            padding: 20px;
            max-width: 300px;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 10px 0;
            color: #333;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .mapboxgl-popup-content p {
            margin: 5px 0;
            color: #666;
        }
        .mapboxgl-popup-content .status {
            font-weight: bold;
            color: #27ae60;
        }
        .mapboxgl-popup-content .status.needs-resupply {
            color: #e74c3c;
        }
        #nearest-kit {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); background: rgba(255,255,255,0.9);
            padding: 15px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: none; text-align: center; font-weight: bold;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .control-button {
            background-color: #002a5c;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .control-button:hover {
            background-color: #004f9f;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        #filters {
            margin-top: 10px;
        }
        .filter-option {
            margin-right: 10px;
        }
        @media (max-width: 600px) {
            #info-panel {
                width: 100%;
                right: 0;
                top: auto;
                bottom: 0;
                max-height: 50vh;
            }
            #info-panel.collapsed {
                transform: translateY(calc(100% - 40px));
            }
            #collapse-button {
                left: 10px;
                top: -30px;
                transform: rotate(90deg);
            }
            #controls {
                top: auto;
                bottom: 10px;
                left: 10px;
            }
        }
        .distance-circle {
            background: rgba(41, 98, 255, 0.1);
            border: 2px solid rgba(41, 98, 255, 0.3);
        }
        #sort-select {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-panel">
        <button id="collapse-button" aria-label="Toggle info panel">â‰¡</button>
        <input type="text" id="search-box" placeholder="Search for a building..." aria-label="Search for a building">
        <select id="sort-select" aria-label="Sort kits">
            <option value="alphabetical">Sort Alphabetically</option>
            <option value="distance">Sort by Distance</option>
        </select>
        <div id="kit-list"></div>
    </div>
    <div id="legend">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='18' fill='%2327ae60' /%3E%3Cpath d='M10 20h20M20 10v20' stroke='white' stroke-width='4' /%3E%3C/svg%3E" alt="First Aid Kit">
        Location of First Aid Kits
    </div>
    <div id="nearest-kit"></div>
    <div id="controls">
        <button id="find-nearest" class="control-button" title="Find the nearest first aid kit">Find Nearest Kit</button>
        <button id="reset-view" class="control-button" title="Reset the map view">Reset View</button>
        <div id="filters">
            <label class="filter-option">
                <input type="checkbox" id="filter-available" checked> Available
            </label>
            <label class="filter-option">
                <input type="checkbox" id="filter-needs-resupply" checked> Needs Resupply
            </label>
        </div>
    </div>
    <div id="loading" aria-live="polite">Searching for nearest kit...</div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ'; // Replace with your Mapbox token

        // Custom map style inspired by University of Toronto's map
        const customStyle = {
            "version": 8,
            "name": "Custom UofT Style",
            "sources": {
                "mapbox": {
                    "type": "vector",
                    "url": "mapbox://mapbox.mapbox-streets-v8"
                }
            },
            "layers": [
                {
                    "id": "background",
                    "type": "background",
                    "paint": {
                        "background-color": "#f8f4f0"
                    }
                },
                {
                    "id": "water",
                    "type": "fill",
                    "source": "mapbox",
                    "source-layer": "water",
                    "paint": {
                        "fill-color": "#a4d1e3"
                    }
                },
                {
                    "id": "landuse",
                    "type": "fill",
                    "source": "mapbox",
                    "source-layer": "landuse",
                    "paint": {
                        "fill-color": [
                            "match",
                            ["get", "class"],
                            "park", "#d8e8c8",
                            "cemetery", "#e0e4dd",
                            "hospital", "#fde",
                            "school", "#f0e8f8",
                            "industrial", "#f0e0d6",
                            "#ebe5e0"
                        ]
                    }
                },
                {
                    "id": "buildings",
                    "type": "fill",
                    "source": "mapbox",
                    "source-layer": "building",
                    "paint": {
                        "fill-color": "#d9d0c9",
                        "fill-outline-color": "#c8b9b0"
                    }
                },
                {
                    "id": "roads",
                    "type": "line",
                    "source": "mapbox",
                    "source-layer": "road",
                    "paint": {
                        "line-color": "#ffffff",
                        "line-width": [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            12, 1,
                            16, 4
                        ]
                    }
                },
                {
                    "id": "road-labels",
                    "type": "symbol",
                    "source": "mapbox",
                    "source-layer": "road",
                    "layout": {
                        "text-field": ["get", "name"],
                        "text-font": ["Open Sans Regular"],
                        "text-size": 12,
                        "text-max-width": 8
                    },
                    "paint": {
                        "text-color": "#765"
                    }
                },
                {
                    "id": "poi-labels",
                    "type": "symbol",
                    "source": "mapbox",
                    "source-layer": "poi_label",
                    "layout": {
                        "text-field": ["get", "name"],
                        "text-font": ["Open Sans Semibold"],
                        "text-size": 11,
                        "text-max-width": 8
                    },
                    "paint": {
                        "text-color": "#000"
                    }
                }
            ]
        };

        var map = new mapboxgl.Map({
            container: 'map',
            style: customStyle,
            center: [-79.3832, 43.6532], // Toronto coordinates
            zoom: 14
        });

        let userLocation = null;
        let kitFeatures = [];
        let supercluster;

        map.on('load', function () {
            fetch('https://raw.githubusercontent.com/ehs-uoft/FA/main/geojson.geojson') // Replace with the path to your GeoJSON file
                .then(response => response.json())
                .then(data => {
                    kitFeatures = data.features;
                    updateMap();
                });

            // Add user location control
            map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            }));
        });

        function updateMap() {
            // Remove existing layers and source
            if (map.getLayer('clusters')) map.removeLayer('clusters');
            if (map.getLayer('cluster-count')) map.removeLayer('cluster-count');
            if (map.getLayer('unclustered-point')) map.removeLayer('unclustered-point');
            if (map.getSource('kits')) map.removeSource('kits');

            // Filter features based on checkbox state
            const availableChecked = document.getElementById('filter-available').checked;
            const needsResupplyChecked = document.getElementById('filter-needs-resupply').checked;
            const filteredFeatures = kitFeatures.filter(feature => {
                const status = feature.properties.status;
                return (availableChecked && status === 'Available') || 
                       (needsResupplyChecked && status === 'Needs Resupply');
            });

            // Create a new source with filtered features
            map.addSource('kits', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: filteredFeatures
                },
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            // Add cluster layers
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'kits',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#51bbd6',
                        100,
                        '#f1f075',
                        750,
                        '#f28cb1'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20,
                        100,
                        30,
                        750,
                        40
                    ]
                }
            });

            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'kits',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                  
'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                }
            });

            map.addLayer({
                id: 'unclustered-point',
                type: 'symbol',
                source: 'kits',
                filter: ['!', ['has', 'point_count']],
                layout: {
                    'icon-image': 'custom-marker',
                    'icon-size': 0.7,
                    'icon-allow-overlap': true
                }
            });

            // Update info panel
            updateInfoPanel(filteredFeatures);
        }

        // Add custom marker image
        map.loadImage(
            'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'>
                    <circle cx='20' cy='20' r='18' fill='#27ae60' />
                    <path d='M10 20h20M20 10v20' stroke='white' stroke-width='4' />
                </svg>
            `),
            (error, image) => {
                if (error) throw error;
                map.addImage('custom-marker', image);
            }
        );

        // Cluster click event
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('kits').getClusterExpansionZoom(clusterId, (err, zoom) => {
                if (err) return;
                map.easeTo({
                    center: features[0].geometry.coordinates,
                    zoom: zoom
                });
            });
        });

        // Single kit click event
        map.on('click', 'unclustered-point', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(createPopupContent(properties))
                .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });

        map.on('mouseenter', 'unclustered-point', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
        });

        // Find nearest kit functionality
        document.getElementById('find-nearest').addEventListener('click', function() {
            document.getElementById('loading').style.display = 'block';
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation = [position.coords.longitude, position.coords.latitude];
                    findNearestKit(kitFeatures, userLocation);
                }, () => {
                    document.getElementById('loading').style.display = 'none';
                    alert("Unable to retrieve your location");
                });
            } else {
                document.getElementById('loading').style.display = 'none';
                alert("Geolocation is not supported by your browser");
            }
        });

        // Reset view button
        document.getElementById('reset-view').addEventListener('click', function() {
            const bounds = new mapboxgl.LngLatBounds();
            kitFeatures.forEach(feature => {
                bounds.extend(feature.geometry.coordinates);
            });
            map.fitBounds(bounds, { padding: 50 });
        });

        // Filter checkboxes
        document.getElementById('filter-available').addEventListener('change', updateMap);
        document.getElementById('filter-needs-resupply').addEventListener('change', updateMap);

        // Collapsible info panel
        document.getElementById('collapse-button').addEventListener('click', function() {
            document.getElementById('info-panel').classList.toggle('collapsed');
        });

        // Sort select
        document.getElementById('sort-select').addEventListener('change', function(e) {
            updateInfoPanel(kitFeatures, e.target.value);
        });

        function createPopupContent(properties) {
            return `
                <h3>${properties.building}</h3>
                <p><strong>Address:</strong> ${properties.address}</p>
                <p><strong>Floor:</strong> ${properties.floor}</p>
                <p><strong>Room:</strong> ${properties.room}</p>
                <p class="status ${properties.status === 'Needs Resupply' ? 'needs-resupply' : ''}">
                    <strong>Status:</strong> ${properties.status}
                </p>
                <p><strong>Last Checked:</strong> ${properties.lastChecked}</p>
            `;
        }

        function findNearestKit(features, userLocation) {
            let nearestKit = null;
            let minDistance = Infinity;

            features.forEach(feature => {
                const distance = turf.distance(
                    turf.point(userLocation),
                    turf.point(feature.geometry.coordinates),
                    {units: 'meters'}
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestKit = feature;
                }
            });

            if (nearestKit) {
                const nearestKitInfo = document.getElementById('nearest-kit');
                nearestKitInfo.style.display = 'block';
                nearestKitInfo.innerHTML = `Nearest Kit: ${nearestKit.properties.building} (${minDistance.toFixed(0)} meters)`;
                
                map.flyTo({
                    center: nearestKit.geometry.coordinates,
                    zoom: 18
                });

                new mapboxgl.Popup()
                    .setLngLat(nearestKit.geometry.coordinates)
                    .setHTML(createPopupContent(nearestKit.properties))
                    .addTo(map);

                // Add distance circles
                addDistanceCircles(userLocation, nearestKit.geometry.coordinates);
            }

            document.getElementById('loading').style.display = 'none';
        }

        function addDistanceCircles(userLocation, kitLocation) {
            // Remove existing distance circles
            if (map.getLayer('distance-circle-500')) map.removeLayer('distance-circle-500');
            if (map.getLayer('distance-circle-1000')) map.removeLayer('distance-circle-1000');
            if (map.getSource('distance-circle-500')) map.removeSource('distance-circle-500');
            if (map.getSource('distance-circle-1000')) map.removeSource('distance-circle-1000');

            // Add 500m circle
            const circle500 = turf.circle(userLocation, 500, {units: 'meters'});
            map.addSource('distance-circle-500', {
                type: 'geojson',
                data: circle500
            });
            map.addLayer({
                id: 'distance-circle-500',
                type: 'fill',
                source: 'distance-circle-500',
                paint: {
                    'fill-color': 'rgba(41, 98, 255, 0.1)',
                    'fill-outline-color': 'rgba(41, 98, 255, 0.3)'
                }
            });

            // Add 1000m circle
            const circle1000 = turf.circle(userLocation, 1000, {units: 'meters'});
            map.addSource('distance-circle-1000', {
                type: 'geojson',
                data: circle1000
            });
            map.addLayer({
                id: 'distance-circle-1000',
                type: 'fill',
                source: 'distance-circle-1000',
                paint: {
                    'fill-color': 'rgba(41, 98, 255, 0.05)',
                    'fill-outline-color': 'rgba(41, 98, 255, 0.2)'
                }
            });
        }

        function updateInfoPanel(features, sortBy = 'alphabetical') {
            const kitList = document.getElementById('kit-list');
            kitList.innerHTML = '';

            let sortedFeatures = [...features];
            if (sortBy === 'alphabetical') {
                sortedFeatures.sort((a, b) => a.properties.building.localeCompare(b.properties.building));
            } else if (sortBy === 'distance' && userLocation) {
                sortedFeatures.sort((a, b) => {
                    const distanceA = turf.distance(turf.point(userLocation), turf.point(a.geometry.coordinates));
                    const distanceB = turf.distance(turf.point(userLocation), turf.point(b.geometry.coordinates));
                    return distanceA - distanceB;
                });
            }

            sortedFeatures.forEach(feature => {
                const div = document.createElement('div');
                div.className = 'kit-item';
                div.innerHTML = `<strong>${feature.properties.building}</strong><br>${feature.properties.address}`;
                div.addEventListener('click', () => {
                    map.flyTo({
                        center: feature.geometry.coordinates,
                        zoom: 18
                    });
                    new mapboxgl.Popup()
                        .setLngLat(feature.geometry.coordinates)
                        .setHTML(createPopupContent(feature.properties))
                        .addTo(map);
                });
                kitList.appendChild(div);
            });
        }

        // Implement virtual scrolling for performance
        const kitList = document.getElementById('kit-list');
        let lastScrollTop = 0;
        kitList.addEventListener('scroll', () => {
            const st = kitList.scrollTop;
            if (st > lastScrollTop) {
                // Scrolling down
                if (st + kitList.offsetHeight >= kitList.scrollHeight - 100) {
                    // Load more items
                    // This is where you would implement logic to load more items
                }
            }
            lastScrollTop = st <= 0 ? 0 : st;
        });
    </script>
</body>
</html>
