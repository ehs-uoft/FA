<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced First Aid Kit Locator</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/supercluster@latest/dist/supercluster.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/gsap.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@latest/turf.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #info-panel {
            position: absolute; top: 10px; right: 10px; width: 300px;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        #info-panel.collapsed { transform: translateX(290px); }
        #collapse-button {
            position: absolute; left: -30px; top: 10px; background: white;
            border: none; border-radius: 5px 0 0 5px; padding: 5px;
            box-shadow: -5px 0 10px rgba(0,0,0,0.1); cursor: pointer;
        }
        #search-box {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc;
            border-radius: 20px; box-sizing: border-box; font-size: 16px;
        }
        .kit-item { 
            background: #f0f0f0; margin-bottom: 10px; padding: 15px; 
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
        }
        .kit-item:hover { 
            background: #e0e0e0; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #legend {
            position: absolute; bottom: 30px; left: 10px; background: rgba(255,255,255,0.9);
            padding: 10px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            font-weight: bold; font-size: 14px; display: flex; align-items: center;
        }
        #legend img { width: 30px; height: 30px; margin-right: 10px; }
        .mapboxgl-popup-content {
            background: rgba(255,255,255,0.95); border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); padding: 20px; max-width: 300px;
        }
        .mapboxgl-popup-content h3 {
            margin: 0 0 10px 0; color: #333;
            border-bottom: 2px solid #3498db; padding-bottom: 5px;
        }
        .mapboxgl-popup-content p { margin: 5px 0; color: #666; }
        #sort-select {
            margin-bottom: 10px; padding: 5px;
            border-radius: 5px; border: 1px solid #ccc;
        }
        #slideout-panel {
            position: fixed; right: -400px; top: 0; bottom: 0; width: 400px;
            background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out; overflow-y: auto; padding: 20px;
            box-sizing: border-box; z-index: 1000;
        }
        #slideout-panel.open { right: 0; }
        .close-slideout {
            position: absolute; top: 10px; right: 10px; cursor: pointer;
            font-size: 20px; color: #333;
        }
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px;
            display: none; z-index: 1000;
        }
        #control-panel {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; border: none; padding: 10px;
            border-radius: 5px; display: flex; flex-direction: column;
        }
        .control-button {
            margin-bottom: 5px; padding: 5px 10px;
            border: none; border-radius: 5px; cursor: pointer;
            background-color: #3498db; color: white;
        }
        #accessibility-panel {
            position: absolute; top: 180px; left: 10px; z-index: 1000;
            background: white; border: none; padding: 10px;
            border-radius: 5px; display: none;
        }
        @media (max-width: 600px) {
            #info-panel, #slideout-panel {
                width: 100%; right: 0; top: auto; bottom: 0; max-height: 50vh;
            }
            #info-panel.collapsed { transform: translateY(calc(100% - 40px)); }
            #collapse-button {
                left: 10px; top: -30px; transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="control-panel">
        <button id="reset-view" class="control-button">Reset View</button>
        <button id="toggle-3d" class="control-button">Toggle 3D</button>
        <button id="nearby" class="control-button">Nearby</button>
        <button id="accessibility-toggle" class="control-button">Accessibility</button>
    </div>
    <div id="accessibility-panel">
        <button id="high-contrast" class="control-button">High Contrast</button>
        <button id="text-to-speech" class="control-button">Text to Speech</button>
        <button id="increase-font" class="control-button">Increase Font</button>
        <button id="decrease-font" class="control-button">Decrease Font</button>
    </div>
    <div id="info-panel">
        <button id="collapse-button" aria-label="Toggle info panel">â‰¡</button>
        <input type="text" id="search-box" placeholder="Search for a building..." aria-label="Search for a building">
        <select id="sort-select" aria-label="Sort buildings">
            <option value="alphabetical">Sort Alphabetically</option>
        </select>
        <div id="kit-list"></div>
    </div>
    <div id="legend">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='18' fill='%2327ae60' /%3E%3Cpath d='M10 20h20M20 10v20' stroke='white' stroke-width='4' /%3E%3C/svg%3E" alt="First Aid Kit"> First Aid Kits
    </div>
    <div id="slideout-panel">
        <span class="close-slideout" aria-label="Close slideout panel">&times;</span>
        <div id="slideout-content"></div>
    </div>
    <div id="loading-indicator">Loading...</div>

    <script>
        // Mapbox setup
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-79.3832, 43.6532],
            zoom: 13
        });

        // Accessibility Panel toggle
        document.getElementById('accessibility-toggle').addEventListener('click', function() {
            const panel = document.getElementById('accessibility-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        // Function to load GeoJSON data
        function loadGeoJson() {
            fetch('https://raw.githubusercontent.com/ehs-uoft/FA/main/geojson.geojson')
                .then(response => response.json())
                .then(data => {
                    map.on('load', () => {
                        map.addSource('kits', { type: 'geojson', data });
                        map.addLayer({
                            id: 'kit-locations',
                            type: 'circle',
                            source: 'kits',
                            paint: {
                                'circle-radius': 10,
                                'circle-color': '#27ae60'
                            }
                        });
                    });
                });
        }
        loadGeoJson();

        // 3D Buildings toggle
        let is3D = false;
        document.getElementById('toggle-3d').addEventListener('click', function() {
            if (!is3D) {
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': 0.6
                    }
                });
            } else {
                map.removeLayer('3d-buildings');
            }
            is3D = !is3D;
        });

        // Info panel functionality
        document.getElementById('collapse-button').addEventListener('click', function() {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('collapsed');
        });

        // Reset map view button
        document.getElementById('reset-view').addEventListener('click', function() {
            map.flyTo({ center: [-79.3832, 43.6532], zoom: 13 });
        });

        // Nearby kits functionality (placeholder)
        document.getElementById('nearby').addEventListener('click', function() {
            // Logic to display nearby kits
        });

        // Load more data, etc.
    </script>
</body>
</html>
