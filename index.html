<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>UTSG First Aid Kit Locator</title>
    <meta name="description" content="Locate first aid kits across the University of Toronto St. George campus">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- Error tracking and monitoring -->
    <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error: ', msg, '\nURL: ', url, '\nLine:', lineNo, 
                      '\nColumn:', columnNo, '\nError object:', error);
        showToast('error', 'An error occurred. Please refresh the page.');
        return false;
    };

    // Performance monitoring
    window.performance.mark('pageStart');
    </script>

    <!-- Preload critical resources -->
    <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" as="style">
    <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" as="script">
    <link rel="preconnect" href="https://api.mapbox.com">
    <link rel="preconnect" href="https://events.mapbox.com">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 10c-17.6 0-32 14.4-32 32 0 24 32 48 32 48s32-24 32-48c0-17.6-14.4-32-32-32zm0 44c-6.6 0-12-5.4-12-12s5.4-12 12-12 12 5.4 12 12-5.4 12-12 12z%22 fill=%22%23e74c3c%22/></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* CSS Custom Properties */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f1c40f;
        --error-color: #e74c3c;
        --background-color: #f8f9fa;
        --text-color: #2c3e50;
        --text-muted: #6c757d;
        --panel-background: rgba(255, 255, 255, 0.98);
        --hover-color: #f1f5f9;
        --border-color: #e2e8f0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --base-font-size: 16px;
        --transition-speed: 0.3s;
        --layer-map: 1;
        --layer-controls: 100;
        --layer-modal: 1000;
        --layer-toast: 2000;
    }

    /* Reset and Base Styles */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: var(--base-font-size);
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        height: 100%;
    }

    body { 
        margin: 0; 
        padding: 0; 
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 
                     Oxygen, Ubuntu, Cantarell, sans-serif;
        color: var(--text-color);
        background-color: var(--background-color);
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        line-height: 1.5;
    }

    /* Map Container */
    #map { 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        width: 100%; 
        height: 100%;
        z-index: var(--layer-map);
        background-color: var(--background-color);
    }

    /* Loading Indicator */
    #loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: var(--layer-toast);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        will-change: transform;
    }

    /* Toast System */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: var(--layer-toast);
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 90%;
        pointer-events: none;
    }

    .toast {
        background: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-color);
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: auto;
        animation: slideIn 0.3s ease-out;
    }

    .toast.error { border-left: 4px solid var(--error-color); }
    .toast.warning { border-left: 4px solid var(--warning-color); }
    .toast.success { border-left: 4px solid var(--success-color); }

    .toast-close {
        background: none;
        border: none;
        padding: 5px;
        cursor: pointer;
        margin-left: auto;
        color: var(--text-muted);
        transition: color var(--transition-speed) ease;
    }

    .toast-close:hover {
        color: var(--text-color);
    }

    /* Info Panel */
    #info-panel {
        position: absolute;
        top: 0;
        right: 0;
        width: 380px;
        height: 100vh;
        background: var(--panel-background);
        box-shadow: -2px 0 10px var(--shadow-color);
        transform: translateX(0);
        transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        z-index: var(--layer-controls);
        display: flex;
        flex-direction: column;
        overscroll-behavior: contain;
        contain: layout size;
        will-change: transform;
    }

    #info-panel.collapsed {
        transform: translateX(380px);
    }

    .panel-header {
        padding: 20px;
        background: var(--primary-color);
        color: white;
        flex-shrink: 0;
    }

    .panel-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 500;
    }

    .search-container {
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid var(--border-color);
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        color: var(--text-muted);
    }

    #search-box {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color var(--transition-speed) ease,
                    box-shadow var(--transition-speed) ease;
        -webkit-appearance: none;
        appearance: none;
    }

    #search-box:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .clear-search {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color var(--transition-speed) ease;
    }

    .clear-search:hover {
        background-color: var(--hover-color);
    }

    /* Kit List */
    #kit-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        overscroll-behavior: contain;
    }

    .kit-item {
        background: white;
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-speed) ease,
                    box-shadow var(--transition-speed) ease,
                    border-color var(--transition-speed) ease;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px var(--shadow-color);
        position: relative;
    }

    .kit-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
        border-color: var(--secondary-color);
    }

    .kit-item h3 {
        font-size: 1.2em;
        margin: 0 0 8px 0;
        color: var(--primary-color);
    }

    .kit-item p {
        margin: 0;
        color: var(--text-muted);
    }

    .kit-item.selected {
        border-color: var(--accent-color);
        background-color: rgba(231, 76, 60, 0.05);
    }

    /* Kit Details Table */
    .table-container {
        margin: 0 20px 20px;
        display: none;
    }

    .table-container.visible {
        display: block;
    }

    .kit-details-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .kit-details-table td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .kit-details-table tr:last-child td {
        border-bottom: none;
    }

    .building-header {
        background: var(--primary-color);
        color: white;
    }

    .building-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .kit-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.9em;
    }

    .kit-info {
        padding: 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }

    .kit-divider {
        border-bottom: 1px solid var(--border-color);
    }

    .kit-detail {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--hover-color);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.95em;
    }

    /* Controls */
    #collapse-button {
        position: absolute;
        left: -48px;
        top: 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px 0 0 8px;
        padding: 12px;
        cursor: pointer;
        transition: background-color var(--transition-speed) ease;
        box-shadow: -2px 0 5px var(--shadow-color);
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: calc(var(--layer-controls) + 1);
    }

    #collapse-button:hover {
        background-color: var(--secondary-color);
    }

    #collapse-button i {
        transition: transform var(--transition-speed) ease;
    }

    #info-panel.collapsed #collapse-button i {
        transform: rotate(180deg);
    }

    #font-controls {
        position: fixed;
        bottom: 20px;
        right: 400px;
        background: var(--panel-background);
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-color);
        z-index: var(--layer-controls);
        display: flex;
        gap: 10px;
    }

    .control-button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color var(--transition-speed) ease;
    }

    .control-button:hover {
        background: var(--secondary-color);
    }

    <div id="toast-container" role="alert" aria-live="polite"></div>

<div id="loading-indicator" role="status">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">Loading map data...</div>
</div>

<div id="font-controls" class="control-group">
    <button class="control-button" id="decrease-font" aria-label="Decrease font size">
        <i class="fas fa-minus" aria-hidden="true"></i>
    </button>
    <button class="control-button" id="increase-font" aria-label="Increase font size">
        <i class="fas fa-plus" aria-hidden="true"></i>
    </button>
</div>

<div id="info-panel" class="panel">
    <button id="collapse-button" aria-label="Toggle info panel">
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
    </button>
    
    <div class="panel-header">
        <h2>First Aid Kit Locations</h2>
    </div>

    <div class="search-container">
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon" aria-hidden="true"></i>
            <input type="text" 
                   id="search-box" 
                   placeholder="Search for a building..." 
                   aria-label="Search for a building"
                   autocomplete="off"
                   spellcheck="false">
            <button class="clear-search hidden" aria-label="Clear search">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <div id="kit-list" class="scrollable-content"></div>
    
    <div class="table-container">
        <table class="kit-details-table">
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="last-updated">Last Updated: Loading...</div>

<div class="modal-overlay" aria-modal="true" aria-hidden="true">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Building Information</h3>
            <button class="modal-close" aria-label="Close modal">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        <div class="modal-content">
            <div class="modal-sidebar">
                <div class="building-quick-info"></div>
            </div>
            <div class="modal-main">
                <iframe class="building-info-frame" 
                        title="Building Information"
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                        loading="lazy">
                </iframe>
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
// Performance monitoring
const perf = {
    marks: new Map(),
    start: (name) => {
        perf.marks.set(name, performance.now());
    },
    end: (name) => {
        const start = perf.marks.get(name);
        if (start) {
            const duration = performance.now() - start;
            console.log(`${name}: ${duration.toFixed(2)}ms`);
            perf.marks.delete(name);
        }
    }
};

(() => {
    'use strict';

    // Constants
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ';
    const GEOJSON_URL = '/FA/geojson.geojson';
    const UNIVERSITY_OF_TORONTO_COORDINATES = [-79.3957, 43.6629];
    const MAP_BOUNDS = [
        [-79.4057, 43.6529], // Southwest
        [-79.3857, 43.6729]  // Northeast
    ];
    const LOAD_TIMEOUT = 15000;

    // State management
    const state = {
        map: null,
        kitFeatures: [],
        mapLoaded: false,
        dataLoaded: false,
        loadingTimeout: null,
        currentFontSize: 1,
        searchDebounceTimeout: null,
        errorTimeout: null,
        selectedBuilding: null,
        modalHistory: [],
        currentBuilding: null,
        networkStatus: {
            isUoftNetwork: false,
            checkedNetwork: false
        }
    };

    // Cache DOM elements
    const elements = {
        map: document.getElementById('map'),
        loading: document.getElementById('loading-indicator'),
        toastContainer: document.getElementById('toast-container'),
        infoPanel: document.getElementById('info-panel'),
        searchBox: document.getElementById('search-box'),
        searchClear: document.querySelector('.clear-search'),
        kitList: document.getElementById('kit-list'),
        tableContainer: document.querySelector('.table-container'),
        lastUpdated: document.getElementById('last-updated'),
        modal: {
            overlay: document.querySelector('.modal-overlay'),
            container: document.querySelector('.modal-container'),
            frame: document.querySelector('.building-info-frame'),
            spinner: document.querySelector('.modal-main .loading-spinner'),
            quickInfo: document.querySelector('.building-quick-info')
        }
    };

    // Toast system
    const toast = {
        create: (type, message, duration = 5000) => {
            const toastElement = document.createElement('div');
            toastElement.className = `toast ${type}`;
            toastElement.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 
                                 type === 'warning' ? 'exclamation-triangle' : 
                                 'check-circle'}" aria-hidden="true"></i>
                <span>${message}</span>
                <button class="toast-close" aria-label="Dismiss message">
                    <i class="fas fa-times"></i>
                </button>
            `;

            elements.toastContainer.appendChild(toastElement);

            const closeToast = () => {
                toastElement.style.opacity = '0';
                setTimeout(() => toastElement.remove(), 300);
            };

            toastElement.querySelector('.toast-close').addEventListener('click', closeToast);

            if (duration) {
                setTimeout(closeToast, duration);
            }
        }
    };

    // Network status check
    async function checkUoftNetwork() {
        if (state.networkStatus.checkedNetwork) {
            return state.networkStatus.isUoftNetwork;
        }

        try {
            const response = await fetch('https://portal.utoronto.ca/network-check', {
                mode: 'no-cors',
                cache: 'no-cache'
            });
            state.networkStatus.isUoftNetwork = true;
        } catch (error) {
            state.networkStatus.isUoftNetwork = false;
        }
        
        state.networkStatus.checkedNetwork = true;
        return state.networkStatus.isUoftNetwork;
    }

    // Map initialization
    async function initializeMap() {
        perf.start('mapInit');
        
        try {
            state.loadingTimeout = setTimeout(() => {
                showLoading(false);
                toast.create('warning', 'Loading is taking longer than expected. Please refresh the page.');
            }, LOAD_TIMEOUT);

            mapboxgl.accessToken = MAPBOX_TOKEN;

            const mapOptions = {
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: UNIVERSITY_OF_TORONTO_COORDINATES,
                zoom: 15,
                minZoom: 14,
                maxBounds: MAP_BOUNDS,
                preserveDrawingBuffer: true,
                trackResize: true,
                renderWorldCopies: false,
                optimizeForTerrain: true,
                maxPitch: 60,
                antialias: true
            };

            if ('ontouchstart' in window) {
                Object.assign(mapOptions, {
                    dragRotate: false,
                    touchPitch: false
                });
            }

            state.map = new mapboxgl.Map(mapOptions);

            state.map.once('load', () => {
                state.mapLoaded = true;
                perf.end('mapInit');
                onMapLoad();
                checkLoadingComplete();
            });

            state.map.on('error', (e) => {
                console.error('Map error:', e);
                toast.create('error', 'Error loading map. Please check your internet connection.');
                showLoading(false);
            });

        } catch (error) {
            console.error('Map initialization error:', error);
            toast.create('error', 'Failed to initialize map. Please refresh the page.');
            showLoading(false);
        }
    }

    // GeoJSON data fetching
    async function fetchGeoJSONData() {
        perf.start('dataFetch');
        
        try {
            const response = await fetch(GEOJSON_URL , {
method: 'GET',
headers: {
'Accept': 'application/json',
'Cache-Control': 'no-cache'
}
});    

if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (!data || !data.features || !Array.isArray(data.features)) {
                throw new Error('Invalid data format');
            }

            state.kitFeatures = data.features;
            state.dataLoaded = true;
            updateLastModifiedDate();
            
            perf.end('dataFetch');
            
            if (state.mapLoaded) {
                addMapLayers(data);
                updateVisibleBuildings();
            }
            
            checkLoadingComplete();
            return data;

        } catch (error) {
            console.error('Error fetching GeoJSON:', error);
            toast.create('error', 'Failed to load location data. Please try again later.');
            showLoading(false);
        }
    }

    // Map layers and controls
    function add3DBuildings() {
        if (state.map.getLayer('3d-buildings')) {
            return;
        }

        state.map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 14,
            'paint': {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    0,
                    15.05,
                    ['get', 'height']
                ],
                'fill-extrusion-base': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    0,
                    15.05,
                    ['get', 'min_height']
                ],
                'fill-extrusion-opacity': 0.6
            }
        }, 'waterway-label');
    }

    function addMapLayers(data) {
        // Create first aid icon
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');

        // Draw regular icon
        ctx.beginPath();
        ctx.arc(16, 16, 14, 0, Math.PI * 2);
        ctx.fillStyle = '#006400';
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.fillRect(8, 14, 16, 4);
        ctx.fillRect(14, 8, 4, 16);

        // Add regular icon
        state.map.addImage('first-aid', { 
            width: 32, 
            height: 32, 
            data: new Uint8Array(ctx.getImageData(0, 0, 32, 32).data)
        });

        // Create selected first aid icon
        ctx.clearRect(0, 0, 32, 32);
        ctx.beginPath();
        ctx.arc(16, 16, 14, 0, Math.PI * 2);
        ctx.fillStyle = '#e74c3c';
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.fillRect(8, 14, 16, 4);
        ctx.fillRect(14, 8, 4, 16);

        // Add selected icon
        state.map.addImage('first-aid-selected', { 
            width: 32, 
            height: 32, 
            data: new Uint8Array(ctx.getImageData(0, 0, 32, 32).data)
        });

        // Add source
        state.map.addSource('kits', {
            type: 'geojson',
            data: data,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 50
        });

        // Add cluster layer
        state.map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'kits',
            filter: ['has', 'point_count'],
            paint: {
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#51bbd6',
                    5,
                    '#2196F3',
                    10,
                    '#3F51B5'
                ],
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    20,
                    5,
                    25,
                    10,
                    30
                ]
            }
        });

        // Add cluster count layer
        state.map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'kits',
            filter: ['has', 'point_count'],
            layout: {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-size': 12
            },
            paint: {
                'text-color': '#ffffff'
            }
        });

        // Add unclustered point layer
        state.map.addLayer({
            id: 'unclustered-point',
            type: 'symbol',
            source: 'kits',
            filter: ['!', ['has', 'point_count']],
            layout: {
                'icon-image': [
                    'case',
                    ['boolean', ['get', 'selected'], false],
                    'first-aid-selected',
                    'first-aid'
                ],
                'icon-size': 0.8,
                'icon-allow-overlap': true
            }
        });

        setupMapEventListeners();
    }

    function addMapControls() {
        // Navigation control
        const nav = new mapboxgl.NavigationControl({
            visualizePitch: true,
            showCompass: true
        });
        state.map.addControl(nav, 'top-left');

        // Fullscreen control
        state.map.addControl(
            new mapboxgl.FullscreenControl({
                container: document.documentElement
            }),
            'top-left'
        );

        // Scale control
        const scale = new mapboxgl.ScaleControl({
            maxWidth: 100,
            unit: 'metric'
        });
        state.map.addControl(scale, 'bottom-left');

        // Geolocate control
        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        });
        state.map.addControl(geolocate, 'top-left');

        // Custom controls container
        const customControls = document.createElement('div');
        customControls.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';

        // 3D toggle button
        const toggle3DButton = document.createElement('button');
        toggle3DButton.className = 'mapboxgl-ctrl-icon custom-ctrl-button toggle-3d';
        toggle3DButton.innerHTML = '<i class="fas fa-cube"></i>';
        toggle3DButton.title = 'Toggle 3D view';
        toggle3DButton.onclick = toggle3DView;

        // Reset view button
        const resetViewButton = document.createElement('button');
        resetViewButton.className = 'mapboxgl-ctrl-icon custom-ctrl-button';
        resetViewButton.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
        resetViewButton.title = 'Reset view';
        resetViewButton.onclick = () => {
            state.map.flyTo({
                center: UNIVERSITY_OF_TORONTO_COORDINATES,
                zoom: 15,
                pitch: 0,
                bearing: 0,
                duration: 1500
            });
        };

        customControls.appendChild(toggle3DButton);
        customControls.appendChild(resetViewButton);
        state.map.addControl({ onAdd: () => customControls, onRemove: () => {} }, 'top-left');
    }

    // 3D View Toggle
    function toggle3DView() {
        const is3DActive = state.map.getPitch() !== 0;
        
        if (!is3DActive) {
            state.map.easeTo({
                pitch: 60,
                bearing: 30,
                duration: 1000
            });
            
            add3DBuildings();
            
            document.querySelector('.toggle-3d i').classList.remove('fa-cube');
            document.querySelector('.toggle-3d i').classList.add('fa-square');
        } else {
            state.map.easeTo({
                pitch: 0,
                bearing: 0,
                duration: 1000
            });
            
            if (state.map.getLayer('3d-buildings')) {
                state.map.removeLayer('3d-buildings');
            }
            
            document.querySelector('.toggle-3d i').classList.remove('fa-square');
            document.querySelector('.toggle-3d i').classList.add('fa-cube');
        }
    }

    // Map event listeners
    function setupMapEventListeners() {
        // Cluster click
        state.map.on('click', 'clusters', (e) => {
            const features = state.map.queryRenderedFeatures(e.point, { 
                layers: ['clusters'] 
            });
            const clusterId = features[0].properties.cluster_id;
            state.map.getSource('kits').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    state.map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        // Single point click
        state.map.on('click', 'unclustered-point', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            showBuildingDetails(e.features[0]);
        });

        // Hover effects
        state.map.on('mouseenter', 'clusters', () => {
            state.map.getCanvas().style.cursor = 'pointer';
        });
        state.map.on('mouseleave', 'clusters', () => {
            state.map.getCanvas().style.cursor = '';
        });

        state.map.on('mouseenter', 'unclustered-point', () => {
            state.map.getCanvas().style.cursor = 'pointer';
        });
        state.map.on('mouseleave', 'unclustered-point', () => {
            state.map.getCanvas().style.cursor = '';
        });
    }

    // Building details handling
    function showBuildingDetails(feature) {
        perf.start('showDetails');
        
        const coordinates = feature.geometry.coordinates;
        state.selectedBuilding = feature;

        // Update map view
        state.map.flyTo({
            center: coordinates,
            zoom: Math.max(state.map.getZoom(), 17),
            speed: 1.2,
            curve: 1.42
        });

        // Update source data
        const updatedFeatures = state.kitFeatures.map(f => ({
            ...f,
            properties: {
                ...f.properties,
                selected: f.properties.building === feature.properties.building
            }
        }));

        if (state.map.getSource('kits')) {
            state.map.getSource('kits').setData({
                type: 'FeatureCollection',
                features: updatedFeatures
            });
        }

        // Update UI
        updateBuildingSelection(feature);
        updateDetailsTable(feature);
        
        perf.end('showDetails');
    }

    function formatFirstAidKits(kits) {
        if (!kits || !kits.length) return 'No kit information available';
        
        return kits.map((kit, index) => `
            <div class="kit-info ${index !== kits.length - 1 ? 'kit-divider' : ''}">
                ${kit.floor ? `<span class="kit-detail">
                    <i class="fas fa-building"></i> Floor: ${kit.floor}
                </span>` : ''}
                ${kit.room ? `<span class="kit-detail">
                    <i class="fas fa-door-open"></i> Room: ${kit.room}
                </span>` : ''}
                ${kit.otherDetails ? `<div class="kit-other-details">
                    <i class="fas fa-info-circle"></i> ${kit.otherDetails}
                </div>` : ''}
            </div>
        `).join('');
    }

    function updateBuildingSelection(feature) {
        const listItems = elements.kitList.querySelectorAll('.kit-item');
        const buildingName = feature.properties.building;
        
        listItems.forEach(item => {
            const isMatch = item.querySelector('h3').textContent === buildingName;
            item.classList.toggle('selected', isMatch);
            
            if (isMatch) {
                item.scrollIntoView({ 
                    behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 
                             'auto' : 'smooth',
                    block: 'nearest'
                });
            }
        });

        elements.tableContainer.classList.add('visible');
        elements.kitList.classList.add('with-table');
    }

    function updateDetailsTable(feature) {
        const tableBody = document.querySelector('.kit-details-table tbody');
        const props = feature.properties;
        
        tableBody.innerHTML = `
            <tr>
                <td class="building-header">
                    <div class="building-title">
                        <h3>${props.building}</h3>
                        <span class="kit-count">
                            ${props.firstAidKits.length} First Aid Kit${props.firstAidKits.length !== 1 ? 's' : ''}
                        </span>
                    </div>
                    <p class="building-address">
                        <i class="fas fa-map-marker-alt"></i> ${props.address || 'Address not available'}
                    </p>
                </td>
            </tr>
            <tr>
                <td class="kits-container">
                    ${formatFirstAidKits(props.firstAidKits)}
                </td>
            </tr>
        `;
    }

    // Search functionality
    function handleSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        elements.searchClear.classList.toggle('hidden', !searchTerm);
        
        if (state.searchDebounceTimeout) {
            clearTimeout(state.searchDebounceTimeout);
        }

        state.searchDebounceTimeout = setTimeout(() => {
            perf.start('search');

            const filteredFeatures = state.kitFeatures.map(feature => ({
                ...feature,
                properties: {
                    ...feature.properties,
                    selected: searchTerm === '' ? false :
                        feature.properties.building.toLowerCase().includes(searchTerm) ||
                        (feature.properties.address && 
                         feature.properties.address.toLowerCase().includes(searchTerm))
                }
            }));

            if (state.map.getSource('kits')) {
                state.map.getSource('kits').setData({
                    type: 'FeatureCollection',
                    features: filteredFeatures
                });
            }

            updateKitList(filteredFeatures);

            const matches = filteredFeatures.filter(f => f.properties.selected);
if (matches.length === 1) {
showBuildingDetails(matches[0]);
} else {
elements.tableContainer.classList.remove('visible');
elements.kitList.classList.remove('with-table');
state.selectedBuilding = null;
}               
        perf.end('search');
        }, 300);
    }

    function clearSearch() {
        elements.searchBox.value = '';
        elements.searchClear.classList.add('hidden');
        handleSearch({ target: elements.searchBox });
    }

    // Kit list updates
    function updateKitList(features) {
        perf.start('updatePanel');

        const fragment = document.createDocumentFragment();
        const searchTerm = elements.searchBox.value.toLowerCase().trim();
        
        const relevantFeatures = searchTerm === '' ? features : 
            features.filter(f => f.properties.selected);

        if (relevantFeatures.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.textContent = 'No buildings found';
            fragment.appendChild(noResults);
        } else {
            relevantFeatures
                .sort((a, b) => a.properties.building.localeCompare(b.properties.building))
                .forEach(feature => {
                    const div = document.createElement('div');
                    div.className = 'kit-item';
                    if (state.selectedBuilding && 
                        feature.properties.building === state.selectedBuilding.properties.building) {
                        div.classList.add('selected');
                    }
                    
                    div.innerHTML = `
                        <h3>${feature.properties.building}</h3>
                        <p><i class="fas fa-map-marker-alt"></i> ${feature.properties.address || 'No address available'}</p>
                        <div class="kit-summary">
                            <span class="kit-badge">
                                <i class="fas fa-first-aid"></i>
                                ${feature.properties.firstAidKits.length} Kit${feature.properties.firstAidKits.length !== 1 ? 's' : ''}
                            </span>
                        </div>
                    `;
                    
                    div.dataset.buildingData = JSON.stringify(feature);
                    fragment.appendChild(div);
                });
        }

        elements.kitList.innerHTML = '';
        elements.kitList.appendChild(fragment);

        perf.end('updatePanel');
    }

    // Font size controls
    function updateFontSize(increase) {
        state.currentFontSize = increase ? 
            Math.min(state.currentFontSize + 0.1, 1.5) : 
            Math.max(state.currentFontSize - 0.1, 0.8);

        document.documentElement.style.setProperty('--base-font-size', 
            `${16 * state.currentFontSize}px`);
    }

    // Layout updates
    function updateLayoutForScreenSize() {
        const isMobile = window.innerWidth <= 768;
        const panel = elements.infoPanel;
        const isCollapsed = panel.classList.contains('collapsed');
        
        if (isMobile) {
            document.documentElement.style.fontSize = '14px';
            state.map.setPadding({
                bottom: isCollapsed ? 0 : (window.innerHeight / 2)
            });
        } else {
            document.documentElement.style.fontSize = '16px';
            state.map.setPadding({
                right: isCollapsed ? 0 : 380
            });
        }

        requestAnimationFrame(() => {
            state.map.resize();
        });
    }

    function updateVisibleBuildings() {
        if (!state.map || !state.map.getSource('kits')) return;

        const bounds = state.map.getBounds();
        const visibleFeatures = state.kitFeatures.filter(feature => {
            const [lng, lat] = feature.geometry.coordinates;
            return bounds.contains([lng, lat]);
        });

        requestAnimationFrame(() => {
            updateKitList(visibleFeatures);
        });
    }

    // Last modified date handling
    async function getLastModifiedDate() {
        try {
            const response = await fetch('https://api.github.com/repos/ehs-uoft/FA/commits?path=geojson.geojson&page=1&per_page=1');
            const [latestCommit] = await response.json();
            const date = new Date(latestCommit.commit.committer.date);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            console.error('Error fetching last modified date:', error);
            return 'Date unavailable';
        }
    }

    async function updateLastModifiedDate() {
        const dateString = await getLastModifiedDate();
        elements.lastUpdated.textContent = `Last Updated: ${dateString}`;
    }

    // Loading management
    function showLoading(show) {
        elements.loading.style.display = show ? 'flex' : 'none';
    }

    function checkLoadingComplete() {
        if (state.mapLoaded && state.dataLoaded) {
            if (state.loadingTimeout) {
                clearTimeout(state.loadingTimeout);
            }
            showLoading(false);
            perf.end('totalLoad');
        }
    }

    // Event listeners setup
    function setupEventListeners() {
        // Map movement events
        state.map.on('moveend', debounce(updateVisibleBuildings, 100));   
        state.map.on('zoomend', debounce(updateVisibleBuildings, 100));

        // Panel toggle
        document.getElementById('collapse-button').addEventListener('click', () => {
            elements.infoPanel.classList.toggle('collapsed');
            updateLayoutForScreenSize();
        });

        // Search
        elements.searchBox.addEventListener('input', handleSearch);
        elements.searchClear.addEventListener('click', clearSearch);

        // Font size controls
        document.getElementById('increase-font').addEventListener('click', () => updateFontSize(true));
        document.getElementById('decrease-font').addEventListener('click', () => updateFontSize(false));

        // Kit list delegation
        elements.kitList.addEventListener('click', (e) => {
            const kitItem = e.target.closest('.kit-item');
            if (!kitItem) return;
            
            try {
                const buildingData = JSON.parse(kitItem.dataset.buildingData);
                showBuildingDetails(buildingData);
            } catch (error) {
                console.error('Error parsing building data:', error);
                toast.create('error', 'Error loading building details');
            }
        });

        // Modal events
        elements.modal.overlay.addEventListener('click', (e) => {
            if (e.target === elements.modal.overlay) {
                hideModal();
            }
        });

        document.querySelector('.modal-close').addEventListener('click', hideModal);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideModal();
                elements.infoPanel.classList.add('collapsed');
            } else if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                elements.searchBox.focus();
            }
        });

        // Window resize
        window.addEventListener('resize', debounce(() => {
            if (state.map) {
                updateLayoutForScreenSize();
            }
        }, 250));

        // Device orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(updateLayoutForScreenSize, 200);
        });

        // Visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (state.searchDebounceTimeout) {
                    clearTimeout(state.searchDebounceTimeout);
                }
            } else {
                updateVisibleBuildings();
            }
        });
    }

    // Utility functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showModal(content) {
        elements.modal.overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function hideModal() {
        elements.modal.overlay.classList.remove('active');
        document.body.style.overflow = '';
        state.modalHistory = [];
    }

    // Map load handler
    function onMapLoad() {
        addMapControls();
        updateLayoutForScreenSize();
        
        if (state.dataLoaded && state.kitFeatures.length > 0) {
            addMapLayers({
                type: 'FeatureCollection',
                features: state.kitFeatures
            });
            updateVisibleBuildings();
        }
    }

    // Application cleanup
    function cleanup() {
        if (state.searchDebounceTimeout) {
            clearTimeout(state.searchDebounceTimeout);
        }
        if (state.loadingTimeout) {
            clearTimeout(state.loadingTimeout);
        }
        if (state.errorTimeout) {
            clearTimeout(state.errorTimeout);
        }
        elements.tableContainer.classList.remove('visible');
        elements.kitList.classList.remove('with-table');
    }

    // Initialize application
    function initializeApplication() {
        perf.start('totalLoad');
        window.performance.mark('appStart');
        
        showLoading(true);

        Promise.all([
            initializeMap(),
            fetchGeoJSONData()
        ]).catch(error => {
            console.error('Initialization error:', error);
            toast.create('error', 'Failed to initialize application. Please refresh the page.');
        }).finally(() => {
            window.performance.mark('appEnd');
            window.performance.measure('Total Initialization', 'appStart', 'appEnd');
        });

        setupEventListeners();
        window.addEventListener('beforeunload', cleanup);
    }

    // Start the application when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApplication);
    } else {
        initializeApplication();
    }
})();
</script>
        </body>
</html>
