<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTSG First Aid Kit Locator</title>

    <!-- Simplified manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlVUU0cgRmlyc3QgQWlkIEtpdCBMb2NhdG9yIiwKICAic2hvcnRfbmFtZSI6ICJGQSBMb2NhdG9yIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDJBNUMiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAyQTVDIgp9">

    <!-- Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .sidebar {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
        }

        .building-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .building-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="sidebar">
        <h2>First Aid Locations</h2>
        <input type="text" id="search" placeholder="Search buildings..." 
               onkeyup="filterBuildings(this.value)">
        <div id="building-list"></div>
    </div>

    <script>
    // State management
    const state = {
        map: null,
        buildings: [],
        selectedBuilding: null
    };

    // Initialize map
    function initMap() {
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWhzIiwiYSI6ImNtMjNsYWtlZzA2bnQycW9qb2F3dHJuM2gifQ.Yw2JtBD13UqJFKtTj-SKsQ';
        state.map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-79.3957, 43.6629], // UofT coordinates
            zoom: 15
        });

        state.map.on('load', () => {
            fetchBuildingData();
        });
    }

    // Fetch building data
    async function fetchBuildingData() {
        try {
            const response = await fetch('/FA/geojson.geojson');
            const data = await response.json();
            state.buildings = data.features;
            displayBuildings();
            addMapMarkers();
        } catch (error) {
            console.error('Error fetching building data:', error);
        }
    }

    // Display buildings in sidebar
    function displayBuildings() {
        const buildingList = document.getElementById('building-list');
        buildingList.innerHTML = state.buildings
            .map(building => `
                <div class="building-item" onclick="selectBuilding('${building.properties.id}')">
                    <h3>${building.properties.building}</h3>
                    <p>${building.properties.address || ''}</p>
                </div>
            `)
            .join('');
    }

    // Add markers to map
    function addMapMarkers() {
        state.buildings.forEach(building => {
            const el = document.createElement('div');
            el.className = 'marker';
            el.style.width = '15px';
            el.style.height = '15px';
            el.style.backgroundColor = '#e74c3c';
            el.style.borderRadius = '50%';

            new mapboxgl.Marker(el)
                .setLngLat(building.geometry.coordinates)
                .addTo(state.map);
        });
    }

    // Select building
    function selectBuilding(buildingId) {
        const building = state.buildings.find(b => b.properties.id === buildingId);
        if (!building) return;

        state.selectedBuilding = building;
        state.map.flyTo({
            center: building.geometry.coordinates,
            zoom: 18
        });
    }

    // Filter buildings
    function filterBuildings(query) {
        const normalizedQuery = query.toLowerCase();
        const buildingItems = document.querySelectorAll('.building-item');
        
        buildingItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(normalizedQuery) ? 'block' : 'none';
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
